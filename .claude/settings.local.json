{
  "permissions": {
    "allow": [
      "Bash(file:*)",
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(git clone:*)",
      "Bash(npm install:*)",
      "Bash(node --check:*)",
      "Bash(tar:*)",
      "Bash(sshpass -p 'UJIr3a9UyH#b' ssh -o StrictHostKeyChecking=no root@37.152.174.87 \"hostname && pwd && whoami\")",
      "Bash(ssh miniapbale:*)",
      "Bash(scp:*)",
      "Bash(python -c \"\nbot_code = ''''''#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\nimport os\nimport time\nimport requests\n\nBOT_TOKEN = os.getenv(''BALE_BOT_TOKEN'', ''64658763:rgYSwBxd05vEuuuNNbNNYZdtA-T1Gxdx5nw'')\nGAME_URL = os.getenv(''GAME_URL'', ''https://snake.darmanjoo.ir'')\nAPI_URL = os.getenv(''API_URL'', ''http://app:3001'')\n\nprint(''Bot starting...'')\nprint(f''Game URL: {GAME_URL}'')\nprint(f''API URL: {API_URL}'')\nprint(''Bot running. Press Ctrl+C to stop.'')\n\n# Keep bot running\nwhile True:\n    time.sleep(60)\n''''''\n\nwith open(''bot/bot.py'', ''w'', encoding=''utf-8'') as f:\n    f.write(bot_code)\n\nprint(''Bot file created'')\n\")",
      "Bash(git init:*)",
      "Bash(git config:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git rm:*)",
      "Bash(git remote add:*)",
      "Bash(git branch:*)",
      "Bash(git push:*)",
      "Bash(git remote:*)",
      "Bash(curl:*)",
      "Bash(ssh:*)",
      "Bash(sshpass -p 'UJIr3a9UyH#b' ssh -o StrictHostKeyChecking=no root@37.152.174.87 \"cat /opt/yalda-snake/bot/bot.py\")",
      "Bash(python -c \"\nbot_code = ''''''#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\nimport os\nimport time\nimport requests\nimport json\nfrom datetime import datetime\nimport threading\n\nBOT_TOKEN = os.getenv(''BALE_BOT_TOKEN'', ''64658763:rgYSwBxd05vEuuuNNbNNYZdtA-T1Gxdx5nw'')\nGAME_URL = os.getenv(''GAME_URL'', ''https://snake.darmanjoo.ir'')\nAPI_URL = os.getenv(''API_URL'', ''http://app:3001'')\nBALE_API = f''https://tapi.bale.ai/bot{BOT_TOKEN}''\n\n# Store user states for conversation flow\nuser_states = {}\n\ndef send_message(chat_id, text, reply_markup=None):\n    \"\"\"\"\"\"Send a message to a user\"\"\"\"\"\"\n    url = f''{BALE_API}/sendMessage''\n    data = {\n        ''chat_id'': chat_id,\n        ''text'': text\n    }\n    if reply_markup:\n        data[''reply_markup''] = json.dumps(reply_markup)\n\n    try:\n        response = requests.post(url, json=data)\n        return response.json()\n    except Exception as e:\n        print(f''Error sending message: {e}'')\n        return None\n\ndef send_game_button(chat_id):\n    \"\"\"\"\"\"Send a button to launch the mini app game\"\"\"\"\"\"\n    keyboard = {\n        ''inline_keyboard'': [[\n            {\n                ''text'': ''ğŸ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ù…Ø§Ø± ÛŒÙ„Ø¯Ø§ÛŒÛŒ'',\n                ''web_app'': {''url'': GAME_URL}\n            }\n        ]]\n    }\n\n    text = \"\"\"\"\"\"\nğŸ® <b>Ú†Ø§Ù„Ø´ Ù…Ø§Ø± ÛŒÙ„Ø¯Ø§ÛŒÛŒ</b>\n\nØ¨Ø§Ø²ÛŒ Ù…Ø§Ø± ÛŒÙ„Ø¯Ø§ÛŒÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!\nØ¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.\n\nğŸ Ø³ÛŒØ¨ = 10 Ø§Ù…ØªÛŒØ§Ø²\nğŸ‰ Ù‡Ù†Ø¯ÙˆØ§Ù†Ù‡ = 20 Ø§Ù…ØªÛŒØ§Ø²\nğŸ‡ Ø§Ù†Ø§Ø± = 30 Ø§Ù…ØªÛŒØ§Ø²\n\nâœ¨ Ø´Ø§Ø¯Ø§Ø¨ÛŒ Ùˆ Ø³Ù„Ø§Ù…Øª Ø¯Ø± Ø³Ø§ÛŒÙ‡ Ø±ÙØ§Ù‡ âœ¨\n\"\"\"\"\"\"\n\n    url = f''{BALE_API}/sendMessage''\n    data = {\n        ''chat_id'': chat_id,\n        ''text'': text,\n        ''parse_mode'': ''HTML'',\n        ''reply_markup'': json.dumps(keyboard)\n    }\n\n    try:\n        response = requests.post(url, json=data)\n        return response.json()\n    except Exception as e:\n        print(f''Error sending game button: {e}'')\n        return None\n\ndef check_user_exists(bale_user_id):\n    \"\"\"\"\"\"Check if user exists in database\"\"\"\"\"\"\n    try:\n        response = requests.get(f''{API_URL}/api/user/{bale_user_id}'', timeout=5)\n        if response.status_code == 200:\n            return response.json()\n        return None\n    except Exception as e:\n        print(f''Error checking user: {e}'')\n        return None\n\ndef register_user_in_db(bale_user_id, phone_number, first_name, last_name, employee_code):\n    \"\"\"\"\"\"Register user in database\"\"\"\"\"\"\n    try:\n        data = {\n            ''baleUserId'': str(bale_user_id),\n            ''phoneNumber'': phone_number,\n            ''firstName'': first_name,\n            ''lastName'': last_name,\n            ''employeeCode'': employee_code\n        }\n        response = requests.post(f''{API_URL}/api/register'', json=data, timeout=5)\n        if response.status_code == 200:\n            return response.json()\n        else:\n            print(f''Registration failed: {response.text}'')\n            return None\n    except Exception as e:\n        print(f''Error registering user: {e}'')\n        return None\n\ndef handle_start(chat_id, user):\n    \"\"\"\"\"\"Handle /start command\"\"\"\"\"\"\n    bale_user_id = user.get(''id'')\n    first_name = user.get(''first_name'', ''Ú©Ø§Ø±Ø¨Ø±'')\n\n    # Check if user already exists in database\n    existing_user = check_user_exists(bale_user_id)\n\n    if existing_user:\n        # User exists - send game button directly\n        welcome_text = f\"\"\"\"\"\"\nØ³Ù„Ø§Ù… {first_name} Ø¹Ø²ÛŒØ²! ğŸ‘‹\n\nØ®ÙˆØ´ Ø¨Ø±Ú¯Ø´ØªÛŒØ¯! ğŸ®\n\nØ´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.\nÙ…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯.\n\nğŸŒ™ Ø´Ø¨ ÛŒÙ„Ø¯Ø§ÛŒ Ø®Ø¬Ø³ØªÙ‡ Ù…Ø¨Ø§Ø±Ú©!\n\"\"\"\"\"\"\n        send_message(chat_id, welcome_text)\n        time.sleep(1)\n        send_game_button(chat_id)\n        user_states[chat_id] = {''state'': ''registered'', ''user_id'': bale_user_id}\n    else:\n        # New user - start registration flow\n        welcome_text = f\"\"\"\"\"\"\nØ³Ù„Ø§Ù… {first_name} Ø¹Ø²ÛŒØ²! ğŸ‘‹\n\nØ¨Ù‡ Ú†Ø§Ù„Ø´ Ù…Ø§Ø± ÛŒÙ„Ø¯Ø§ÛŒÛŒ Ø§Ø¯Ø§Ø±Ù‡ Ú©Ù„ Ø±ÙØ§Ù‡ Ùˆ Ø¯Ø±Ù…Ø§Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ğŸ®\n\nğŸŒ™ Ø´Ø¨ ÛŒÙ„Ø¯Ø§ Ù…Ø¨Ø§Ø±Ú©!\n\nØ¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\n\nâœ… Ù†Ø§Ù…\nâœ… Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ\nâœ… Ú©Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…ÛŒ\nâœ… Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³\n\nÙ„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\"\"\"\"\"\"\n        send_message(chat_id, welcome_text)\n        user_states[chat_id] = {\n            ''state'': ''waiting_first_name'',\n            ''user_id'': bale_user_id\n        }\n\ndef handle_first_name(chat_id, first_name):\n    \"\"\"\"\"\"Handle first name input\"\"\"\"\"\"\n    if not first_name or len(first_name) < 2:\n        send_message(chat_id, ''âŒ Ù†Ø§Ù… Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'')\n        return\n\n    user_states[chat_id][''first_name''] = first_name\n    user_states[chat_id][''state''] = ''waiting_last_name''\n\n    send_message(chat_id, ''âœ… Ù†Ø§Ù… Ø«Ø¨Øª Ø´Ø¯.\\n\\nØ­Ø§Ù„Ø§ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:'')\n\ndef handle_last_name(chat_id, last_name):\n    \"\"\"\"\"\"Handle last name input\"\"\"\"\"\"\n    if not last_name or len(last_name) < 2:\n        send_message(chat_id, ''âŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'')\n        return\n\n    user_states[chat_id][''last_name''] = last_name\n    user_states[chat_id][''state''] = ''waiting_employee_code''\n\n    send_message(chat_id, ''âœ… Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø«Ø¨Øª Ø´Ø¯.\\n\\nØ­Ø§Ù„Ø§ Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:'')\n\ndef handle_employee_code(chat_id, employee_code):\n    \"\"\"\"\"\"Handle employee code input\"\"\"\"\"\"\n    # Validate employee code (basic validation)\n    if not employee_code or len(employee_code) < 3:\n        send_message(chat_id, ''âŒ Ú©Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'')\n        return\n\n    user_states[chat_id][''employee_code''] = employee_code\n    user_states[chat_id][''state''] = ''waiting_phone''\n\n    send_message(chat_id, ''âœ… Ú©Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…ÛŒ Ø«Ø¨Øª Ø´Ø¯.\\n\\nØ­Ø§Ù„Ø§ Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:'')\n\ndef handle_phone_number(chat_id, phone_number):\n    \"\"\"\"\"\"Handle phone number input and complete registration\"\"\"\"\"\"\n    # Validate phone number (basic validation)\n    phone_clean = phone_number.replace('' '', '''').replace(''-'', '''')\n    if not phone_clean or len(phone_clean) < 10:\n        send_message(chat_id, ''âŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:'')\n        return\n\n    user_data = user_states[chat_id]\n    bale_user_id = user_data.get(''user_id'')\n    first_name = user_data.get(''first_name'')\n    last_name = user_data.get(''last_name'')\n    employee_code = user_data.get(''employee_code'')\n\n    # Register user in database\n    result = register_user_in_db(bale_user_id, phone_clean, first_name, last_name, employee_code)\n\n    if result and result.get(''success''):\n        user_states[chat_id][''phone_number''] = phone_clean\n        user_states[chat_id][''state''] = ''registered''\n\n        # Confirmation message\n        confirmation_text = f\"\"\"\"\"\"\nâœ… <b>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</b>\n\nğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§:\nâ€¢ Ù†Ø§Ù…: {first_name} {last_name}\nâ€¢ Ú©Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…ÛŒ: {employee_code}\nâ€¢ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: {phone_number}\n\nØ­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯! ğŸ®\n\"\"\"\"\"\"\n        send_message(chat_id, confirmation_text)\n\n        # Send game button\n        time.sleep(1)\n        send_game_button(chat_id)\n    else:\n        send_message(chat_id, ''âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\\n\\nØ¯Ø³ØªÙˆØ± /start Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.'')\n        user_states.pop(chat_id, None)\n\ndef handle_message(message):\n    \"\"\"\"\"\"Handle incoming messages\"\"\"\"\"\"\n    chat_id = message[''chat''][''id'']\n    user = message.get(''from'', {})\n    text = message.get(''text'', '''').strip()\n\n    print(f''Message from {chat_id}: {text}'')\n\n    # Handle /start command\n    if text.startswith(''/start''):\n        handle_start(chat_id, user)\n        return\n\n    # Check user state\n    user_state = user_states.get(chat_id, {})\n    current_state = user_state.get(''state'')\n\n    if current_state == ''waiting_first_name'':\n        handle_first_name(chat_id, text)\n    elif current_state == ''waiting_last_name'':\n        handle_last_name(chat_id, text)\n    elif current_state == ''waiting_employee_code'':\n        handle_employee_code(chat_id, text)\n    elif current_state == ''waiting_phone'':\n        handle_phone_number(chat_id, text)\n    elif current_state == ''registered'':\n        # User already registered, send game button again\n        send_game_button(chat_id)\n    else:\n        # Unknown state, restart\n        send_message(chat_id, ''Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªÙˆØ± /start Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ØªØ§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒÙ….'')\n\ndef get_updates(offset=None):\n    \"\"\"\"\"\"Get updates from Bale\"\"\"\"\"\"\n    url = f''{BALE_API}/getUpdates''\n    params = {''timeout'': 30}\n    if offset:\n        params[''offset''] = offset\n\n    try:\n        response = requests.get(url, params=params, timeout=35)\n        return response.json()\n    except Exception as e:\n        print(f''Error getting updates: {e}'')\n        return None\n\ndef post_leaderboard():\n    \"\"\"\"\"\"Post leaderboard to channel (every 30 minutes)\"\"\"\"\"\"\n    # TODO: Implement channel posting\n    # This would need a channel ID where leaderboard is posted\n    try:\n        # Get top 10 players\n        response = requests.get(f''{API_URL}/api/leaderboard/top/10'', timeout=5)\n        if response.status_code == 200:\n            leaderboard = response.json()\n            # Format leaderboard message\n            # Channel posting would go here\n            print(''Leaderboard:'', leaderboard)\n    except Exception as e:\n        print(f''Error posting leaderboard: {e}'')\n\ndef leaderboard_scheduler():\n    \"\"\"\"\"\"Schedule leaderboard posting every 30 minutes\"\"\"\"\"\"\n    while True:\n        try:\n            time.sleep(1800)  # 30 minutes\n            post_leaderboard()\n        except Exception as e:\n            print(f''Error in leaderboard scheduler: {e}'')\n\ndef main():\n    \"\"\"\"\"\"Main bot loop\"\"\"\"\"\"\n    print(''Bot starting...'')\n    print(f''Game URL: {GAME_URL}'')\n    print(f''API URL: {API_URL}'')\n    print(f''Bale API: {BALE_API}'')\n    print(''Bot running. Press Ctrl+C to stop.'')\n\n    # Start leaderboard scheduler in background\n    scheduler_thread = threading.Thread(target=leaderboard_scheduler, daemon=True)\n    scheduler_thread.start()\n\n    offset = None\n\n    while True:\n        try:\n            updates = get_updates(offset)\n\n            if not updates or not updates.get(''ok''):\n                time.sleep(1)\n                continue\n\n            for update in updates.get(''result'', []):\n                offset = update[''update_id''] + 1\n\n                if ''message'' in update:\n                    handle_message(update[''message''])\n\n        except KeyboardInterrupt:\n            print(''\\\\nBot stopped.'')\n            break\n        except Exception as e:\n            print(f''Error in main loop: {e}'')\n            time.sleep(5)\n\nif __name__ == ''__main__'':\n    main()\n''''''\n\nwith open(''bot/bot.py'', ''w'', encoding=''utf-8'') as f:\n    f.write(bot_code)\n\nprint(''Bot file updated'')\n\")",
      "Bash(sshpass -p 'UJIr3a9UyH#b' ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub root@37.152.174.87)",
      "Bash(echo:*)",
      "Bash(chmod:*)",
      "Bash(node:*)",
      "WebFetch(domain:github.com)",
      "Bash(sshpass:*)"
    ]
  }
}
